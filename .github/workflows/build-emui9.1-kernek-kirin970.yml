name: Build Emui9.1 kernek kirin970 and Create Release

on:
  workflow_dispatch:
  
env:
  REPO_URL: https://github.com/LeeHe-gif/kirin970-kernel-based-on-emui9.1.git
  REPO_BRANCH: main
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl build-essential \
            libncurses-dev bison bc flex libssl-dev \
            gcc-arm-linux-gnueabi xz-utils ccache rsync \
            libelf-dev rsync kmod git cpio wget zip \
            unzip make 
            
      - name: Cache Python 2.7
        uses: actions/cache@v4
        with:
          path: Python-2.7.18
          key: python-2.7.18
          restore-keys: |
            python-2.7.18

      - name: install python2.7 from cache
        run: |
          cd  Python-2.7.18
          sudo make install

      - name: Clone kernel source and setup KernelSU
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH kernel_source
          cd kernel_source
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5

      - name: Build kernel
        run: |
          cp scripts/build6.sh kernel_source/
          cd kernel_source
          chmod 755 build6.sh
          ./build6.sh

      - name: pack bootimg
        run: |
          cd kernel_source
          chmod 755 pack.sh
          ./pack.sh

      - name: Create out directory archive
        run: |
          cd kernel_source
          zip -r kernel_boot_directory.zip out/arch/arm64/boot
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kirin970-kernel-build-artifacts
          path: |
            kernel_source/build_out/*.img
            kernel_source/kernel_boot_directory.zip
          retention-days: 30
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: kirin970-kernel-build-artifacts
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "当前目录结构:"
          pwd
          ls -la
          echo "Artifacts 目录结构:"
          ls -la ./artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "kirin970-kernel-build"
          name: "kirin970 Kernel Build"
          body: |
            # kirin970 Kernel Build

            华为 nova3 docker support 内核
            ## 包含文件：
            - `kernel-20xxxxxx-enforcing.img`
            - `kernel-20xxxxxx-permissive.img`
            - `kernel_boot_directory.zip` - 完整的编译输出目录

            ## 特性：
            - ✅ 完整 Docker 容器支持
            - ✅ 基于 [kirin970-kernel-based-on-emui9.1](https://github.com/LeeHe-gif/kirin970-kernel-based-on-emui9.1)** 源码

            ## 刷机说明
            1. 下载 boot img 镜像，刷入
            2. 重启设备

            **注意：** 刷机前请备份重要数据。
          draft: false
          prerelease: false
          files: |
            ./artifacts/build_out/*.img
            ./artifacts/kernel_boot_directory.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
