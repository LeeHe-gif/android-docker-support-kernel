name: Build ZTE U30AIR Kernel and Create Release

on:
  workflow_dispatch:
  
env:
  REPO_URL: https://github.com/LeeHe-gif/android_kernel_zte_ums9620_mifi_u30air
  REPO_BRANCH: main
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl build-essential \
            libncurses-dev bison bc flex libssl-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            libelf-dev rsync kmod git cpio wget zip \
            unzip python3 python-is-python3 make xz-utils python3-pip ccache rsync

      - name: Clone kernel source
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH kernel_source
  
      - name: Build kernel with clang 12.1.0 (clang-r416183b)
        run: |
          cp build4.sh kernel_source/
          cd kernel_source
          chmod 755 build4.sh
          ./build4.sh
            
      - name: Verify build output
        run: |
          echo "检查构建输出:"
          ls -la kernel_source/out/arch/arm64/boot/ || echo "构建输出目录不存在"
          [ -f "kernel_source/out/arch/arm64/boot/Image.gz" ] && echo "✅ Image.gz 存在" || echo "❌ Image.gz 不存在"
       
      - name: Create out directory archive
        run: |
          cd kernel_source
          zip -r kernel_boot_directory.zip out/arch/arm64/boot
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: u30air-kernel-build-artifacts
          path: |
            kernel_source/kernel_boot_directory.zip
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: u30air-kernel-build-artifacts
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "当前目录结构:"
          pwd
          ls -la
          echo "Artifacts 目录结构:"
          ls -la ./artifacts/
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "zte-u30air-kernel-build"
          name: "zte-u30air kernel build"
          body: |
            # Kernel Build
          
            ## 包含文件：
            - `kernel_boot_directory.zip` - 完整的编译输出目录
            ## 说明：
            - ✅ 基于 [这个](https://github.com/Enceka/android_kernel_zte_ums9620_mifi_u30air.git) 内核源码
            - ✅ 使用 clang 12.1.0 编译

          draft: false
          prerelease: false
          files: |
            ./artifacts/kernel_source/kernel_boot_directory.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
