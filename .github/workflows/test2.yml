name: Build ZTE U30AIR Kernel and Create Release

on:
  workflow_dispatch:
    inputs:
      config:
        description: "chose the config"
        required: false
        default: "original"
        type: choice
        options:
          - original
          - changed

      thread:
        description: "Compile thread"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - 1

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true

      - name: Setup massive swap
        run: |
          free -h
          # 创建大容量swap文件 
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h
          echo "Swap setup completed"
    
      - name: Show hardware info
        run: |
          chmod 755 ./scripts/show_hardware_info.sh
          ./scripts/show_hardware_info.sh

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl build-essential \
            libncurses-dev bison bc flex libssl-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            libelf-dev rsync kmod git cpio wget zip \
            unzip python3 python-is-python3 make u-boot-tools \
            xz-utils python3-pip ccache rsync dos2unix

      - name: wget kernel source
        run: |
          wget -O U30Air_AndroidT_kernel-5.4.254.tar.gz "https://download.ztedevices.com/device/global/support/opensource/2/20240424_01/U30Air_AndroidT_kernel(5.4.254).tar.gz#W3"
          mkdir -p kernel_source
          tar -xzf U30Air_AndroidT_kernel-5.4.254.tar.gz -C kernel_source
  
      - name: Build kernel with clang 12.1.0 (clang-r416183b)
        run: |
          if [[ "${{ inputs.thread }}" == "1" ]]; then
            sed -i 's/make -j$(nproc --all) O=out /make -j1 V=s O=out /' scripts/build5.sh
          fi
          cp scripts/build5.sh kernel_source/bsp/kernel5.4/kernel5.4/
          mkdir -p kernel_source/bsp/kernel5.4/kernel5.4/out
          if [[ "${{ inputs.config }}" == "original" ]]; then
            cp config/config kernel_source/bsp/kernel5.4/kernel5.4/out/.config
          else
            cp config/my_U30Air_defconfig kernel_source/bsp/kernel5.4/kernel5.4/out/.config
          fi
          cd kernel_source/bsp/kernel5.4/kernel5.4/
          chmod 755 build5.sh
          ./build5.sh
          
      - name: Create out directory archive
        run: |
          cd kernel_source/bsp/kernel5.4/kernel5.4/
          cd out
          ls -a
          zip -r kernel_out_directory.zip sound scripts block crypto virt fs certs init lib security arch kernel usr mm ipc net include drivers .config vmlinux vmlinux.o .config.old .tmp*_ .version .vmlinux.cmd .missing-syscalls.d modules.builtin modules.builtin.modinfo modules.order Makefile Module.symvers System.map
          ls -a
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: u30air-kernel-build-artifacts-2
          path: |
            kernel_source/bsp/kernel5.4/kernel5.4/out/kernel_out_directory.zip
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: u30air-kernel-build-artifacts-2
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "当前目录结构:"
          pwd
          ls -la
          echo "Artifacts 目录结构:"
          ls -la ./artifacts/
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "zte-u30air-kernel-build"
          name: "zte-u30air kernel build"
          body: |
            # Kernel Build
          
            ## 包含文件：
            - `kernel_out_directory.zip` - 完整的编译输出目录
            ## 说明：
            - ✅ 基于 [这个](https://github.com/Enceka/android_kernel_zte_ums9620_mifi_u30air.git) 内核源码
            - ✅ 使用 clang 12.1.0 编译

          draft: false
          prerelease: false
          files: |
            ./artifacts/kernel_out_directory.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
